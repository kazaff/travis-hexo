<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="译-Sinon入门:利用Mocks，Spies和Stubs完成javascript测试"><meta name="keywords" content="test,ajax,mock,sinon"><meta name="author" content="kazaff,edisondik@gmail.com"><meta name="copyright" content="kazaff"><title>译-Sinon入门:利用Mocks，Spies和Stubs完成javascript测试 | kazaff's blog</title><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '3.9.0'
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#译文"><span class="toc-number">1.</span> <span class="toc-text">译文</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#是什么让Sinon如此重要？"><span class="toc-number">1.1.</span> <span class="toc-text">是什么让Sinon如此重要？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Sinon是怎么工作的？"><span class="toc-number">1.2.</span> <span class="toc-text">Sinon是怎么工作的？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装Sinon"><span class="toc-number">1.3.</span> <span class="toc-text">安装Sinon</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Nodejs"><span class="toc-number">1.3.1.</span> <span class="toc-text">Nodejs</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#浏览器"><span class="toc-number">1.3.2.</span> <span class="toc-text">浏览器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#入门指南"><span class="toc-number">1.4.</span> <span class="toc-text">入门指南</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Spies"><span class="toc-number">1.5.</span> <span class="toc-text">Spies</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sinons断言"><span class="toc-number">1.6.</span> <span class="toc-text">sinons断言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Stubs"><span class="toc-number">1.7.</span> <span class="toc-text">Stubs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Mocks"><span class="toc-number">1.8.</span> <span class="toc-text">Mocks</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#重要的最佳实践：使用sinon-test"><span class="toc-number">1.9.</span> <span class="toc-text">重要的最佳实践：使用sinon.test()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Sinon并不是黑魔法"><span class="toc-number">1.10.</span> <span class="toc-text">Sinon并不是黑魔法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#关于Stub-Then？"><span class="toc-number">1.10.1.</span> <span class="toc-text">关于Stub Then？</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#总结"><span class="toc-number">1.11.</span> <span class="toc-text">总结</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.jpg"></div><div class="author-info__name text-center">kazaff</div><div class="author-info__description text-center">coder,leader,tinker</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">198</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">431</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">20</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/img/banner.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">kazaff's blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">译-Sinon入门:利用Mocks，Spies和Stubs完成javascript测试</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 11月 11 2016</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/nodejs/">nodejs</a><span class="post-meta__separator">|</span><i class="fa fa-comment-o post-meta__icon" aria-hidden="true"></i><a href="/2016/11/11/译-Sinon入门：利用Mocks，Spies和Stubs完成javascript测试/#disqus_thread"><span class="disqus-comment-count" data-disqus-identifier="2016/11/11/译-Sinon入门：利用Mocks，Spies和Stubs完成javascript测试/"></span></a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>最近写完一个基于nodejs的组件后的我打算为其写一下单元测试，本以为之前了解过相当多的关于测试的知识，应该可以很顺利的搞定，可真的去写测试项的时候才发现依然存在一些需要克服的困难。不过，接下来翻译的这篇文章就是专门针对测试神器的，应该可以帮到和我一样的新手。</p>
<p>原文地址：<a href="https://www.sitepoint.com/sinon-tutorial-javascript-testing-mocks-spies-stubs/" target="_blank" rel="noopener">https://www.sitepoint.com/sinon-tutorial-javascript-testing-mocks-spies-stubs/</a><br><a id="more"></a></p>
<h2 id="译文"><a href="#译文" class="headerlink" title="译文"></a>译文</h2><p>当我们写单元测试时一个最大的绊脚石是当你面对的代码过于复杂。</p>
<p>在真实的项目中，我们的代码经常要做各种导致我们测试很难进行的事情。Ajax请求，timer，日期，跨浏览器特性…或者如果你使用Nodejs，则面对数据库，网络，文件操作等。</p>
<p>所有这些事情之所以不容易测试是因为你无法轻易用代码控制它们。如果你使用Ajax，你需要一个服务端来响应请求，这样才能让你的测试项通过。如果你使用<code>setTimeout</code>，你的测试项不得不等待它。如果是数据库或网络，也类似–你需要一个包含正确数据的数据库，或一个网络服务。</p>
<p>真实世界不像那些测试教程里看起来的那样简单。但你知道有一个解决方案么？</p>
<p><strong>By using Sinon, we can make testing non-trivial code trivial!</strong> （译者：这个口号不太好翻译，non-trivial）</p>
<p>让我们看看该怎么做。</p>
<h3 id="是什么让Sinon如此重要？"><a href="#是什么让Sinon如此重要？" class="headerlink" title="是什么让Sinon如此重要？"></a>是什么让Sinon如此重要？</h3><p>简单的说，<a href="http://sinonjs.org/" target="_blank" rel="noopener">Sinon</a>允许你去替换代码中复杂的部分，以此来简化你的测试代码。</p>
<p>当我们测试某部分代码时，你不希望受到其它部分的影响。如果有外部因素影响测试，那么测试项将变得非常复杂且不稳定。</p>
<p>如果你想测试一个使用了ajax的代码，你该怎么做？你需要跑一个服务端，并保证该服务端返回指定的响应数据来支撑你的测试项。这很难完成也让运行测试很麻烦。</p>
<p>那如果你的代码依赖时间呢？假如它需要等待一秒钟才执行。怎么办？你需要在你的测试项中使用<code>setTimeout</code>，但这会让测试变得缓慢。想像一下，如果间隔时间很久，例如五分钟。我想你不会希望每次跑测试项都等待五分钟吧。</p>
<p>如果使用Sinon，我们可以搞定这些问题（甚至更多），并减少复杂度。</p>
<h3 id="Sinon是怎么工作的？"><a href="#Sinon是怎么工作的？" class="headerlink" title="Sinon是怎么工作的？"></a>Sinon是怎么工作的？</h3><p>Sinon通过允许我们简单的创建<code>test-doubles</code>从而帮助我们减少测试项编写的复杂度。</p>
<p>正如它名字一样，Test-doubles作用是在测试中替换某部分代码。上面提到的ajax的例子中，不需要创建服务端，我们可以使用<code>test-doubles</code>替换掉Ajax调用。在timer例子中，我们可以使用<code>test-doubles</code>来控制时间。</p>
<p>听起来可能很复杂，但基本思想很简单。基于javascript的动态性，我们可以替换任何函数。Test-doubles只是在这个思想的基础上走的更远了一些。使用Sinon，我们可以使用test-doubles替换任何javascript函数，并提供很多方便测试的配置。</p>
<p>Sinon中<code>test-doubles</code>分三类：</p>
<ul>
<li><a href="http://sinonjs.org/docs/#spies" target="_blank" rel="noopener">Spies</a>，提供了函数调用的信息，但不会改变其行为（译者注：类似动态代理）</li>
<li><a href="http://sinonjs.org/docs/#stubs" target="_blank" rel="noopener">Stubs</a>，类似Spies，但是是完全替换目标函数。这可以让你随心所欲的控制函数–抛异常，返回指定结果等</li>
<li><a href="http://sinonjs.org/docs/#mocks" target="_blank" rel="noopener">Mocks</a>，提供了替换整个对象的能力</li>
</ul>
<p>此外，Sinon还提供了其他的辅助功能，本文不包含下面的范围：</p>
<ul>
<li><a href="http://sinonjs.org/docs/#clock" target="_blank" rel="noopener">Fake timers</a>，用来控制时间，例如触发一个<code>setTimeout</code></li>
<li><a href="http://sinonjs.org/docs/#server" target="_blank" rel="noopener">Fake XMLHttpResquest and server</a>，可以用来伪造Ajax请求和响应</li>
</ul>
<p>基于这些功能，Sinon可以让你解决测试中遇到的由外部依赖带来的所有复杂问题。如果你学会了Sinon提供的这些技巧，你几乎不需要其它别的工具了。</p>
<h3 id="安装Sinon"><a href="#安装Sinon" class="headerlink" title="安装Sinon"></a>安装Sinon</h3><p>开始之前，我们需要安装Sinon</p>
<h4 id="Nodejs"><a href="#Nodejs" class="headerlink" title="Nodejs"></a>Nodejs</h4><ol>
<li>使用<code>npm install sinon</code>安装sinon</li>
<li>在测试项中引入sinon：<code>var sinon = require(&#39;sinon&#39;);</code></li>
</ol>
<h4 id="浏览器"><a href="#浏览器" class="headerlink" title="浏览器"></a>浏览器</h4><ol>
<li>你可以选择<code>npm install sinon</code>，或使用<a href="https://cdnjs.com/libraries/sinon.js" target="_blank" rel="noopener">CDN</a>，也可以从<a href="http://sinonjs.org/download/" target="_blank" rel="noopener">官网</a>下载到本地</li>
<li>在你的测试页面引入<code>sinon.js</code></li>
</ol>
<h3 id="入门指南"><a href="#入门指南" class="headerlink" title="入门指南"></a>入门指南</h3><p>sinon包含许多功能，但它们多数都存在关系。你只需要掌握一部分，就会了解剩余部分。这让sinon很容易使用，只需要你了解了基本用法并知道它们之间的差别。</p>
<p>只要我们的代码调用了一个不容易控制的函数，我们通常就需要sinon。</p>
<p>对于Ajax，它可能是<code>$.get</code>或者<code>XMLHttpResquest</code>。对于timer，它可能是<code>setTimeout</code>。对于数据库，它可能是<code>mongodb.findOne</code>。</p>
<p>为了方便我们讨论，后面我将成这类函数为依赖方。我们测试的目标函数依赖其它函数的返回结果。</p>
<p>最常见的使用sinon方式是<strong>使用test-doubles替换掉问题依赖方</strong>。</p>
<ul>
<li>当测试Ajax时，我们使用<code>test-doubles</code>替换<code>XMLHttpResquest</code>来伪造ajax请求</li>
<li>当测试timer时，我们伪造替换<code>setTimeout</code></li>
<li>当测试数据库时，我们使用<code>test-doubles</code>来替换<code>mongodb.findOne</code>来直接返回伪造数据</li>
</ul>
<p>让我们写点代码吧。</p>
<h3 id="Spies"><a href="#Spies" class="headerlink" title="Spies"></a>Spies</h3><p>Spies很简单，但其它很多功能依赖它。</p>
<p>spies的主要用法是收集函数的调用信息。你可以用来验证一些事儿，例如函数是否被调用。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> spy = sinon.spy();</span><br><span class="line"></span><br><span class="line"><span class="comment">//我们可以像调用函数一样调用spy</span></span><br><span class="line">spy(<span class="string">'Hello'</span>, <span class="string">'World'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//我们可以得到调用信息</span></span><br><span class="line"><span class="built_in">console</span>.log(spy.firstCall.args); <span class="comment">//output: ['Hello', 'World']</span></span><br></pre></td></tr></table></figure>
<p><code>sinon.spy</code>函数返回一个<code>Spy</code>对象，该对象可以像函数一样被调用，它记录每次被调用信息。在上面的例子里，<code>firstCall</code>属性包含了第一次调用的信息，例如<code>firstCall.args</code>表示调用时的参数列表。</p>
<p>虽然你可以像上面例子那样创建一个匿名spies，但通常情况下你需要使用<code>spy</code>替换一个其它函数。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">var</span> user = &#123;</span><br><span class="line">  ...</span><br><span class="line">  setName: <span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.name = name;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//为user.setName创建一个spy</span></span><br><span class="line"><span class="keyword">var</span> setNameSpy = sinon.spy(user, <span class="string">'setName'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//现在，每次调用目标函数，spy都会记录相关信息</span></span><br><span class="line">user.setName(<span class="string">'Darth Vader'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//我们可以使用spy对象查看相关信息</span></span><br><span class="line"><span class="built_in">console</span>.log(setNameSpy.callCount); <span class="comment">//output: 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//非常重要的步骤--拆除spy</span></span><br><span class="line">setNameSpy.restore();</span><br></pre></td></tr></table></figure>
<p>上面例子展示了使用spy替换其它函数的写法，最重要的一点是：当你确定不再需要spy后，你记得恢复原始函数，参考例子中的最后一行。不然测试可能出现非预期行为。</p>
<p>Spies包含许多不同的属性，用来提供不同的信息。<a href="http://sinonjs.org/docs/#spies-api" target="_blank" rel="noopener">spy文档</a>列出了完整的属性列表。</p>
<p>在实际场景中，你可能不会经常使用spies。你更多时候使用的是stub，但是spies用来检测函数是否被调用非常方便：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myFunction</span>(<span class="params">condition, callback</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(condition)&#123;</span><br><span class="line">    callback();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">describe(<span class="string">'myFunction'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  it(<span class="string">'should call the callback function'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> callback = sinon.spy();</span><br><span class="line"></span><br><span class="line">    myFunction(<span class="literal">true</span>, callback);</span><br><span class="line"></span><br><span class="line">    assert(callback.calledOnce);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>在这个例子中，我们使用<a href="https://mochajs.org/" target="_blank" rel="noopener">Mocha</a>作为测试框架，使用<a href="http://chaijs.com/" target="_blank" rel="noopener">Chai</a>作为断言库。如果你想了解更多信息，可以参考我之前的文章：<a href="http://www.sitepoint.com/unit-test-javascript-mocha-chai/" target="_blank" rel="noopener">使用Mocha和Chai来单元测试你的javascript</a>。</p>
<p>See the Pen <a href="http://codepen.io/SitePoint/pen/XdbYzb/" target="_blank" rel="noopener"> Sinon Tutorial: JavaScript Testing with Mocks, Spies &amp; Stubs</a></p>
<h3 id="sinons断言"><a href="#sinons断言" class="headerlink" title="sinons断言"></a>sinons断言</h3><p>在我们介绍stubs之前，我们快速看一下<a href="http://sinonjs.org/docs/#assertions" target="_blank" rel="noopener">sinon断言</a>。</p>
<p>大多数使用spies（和stubs）的测试方案中，你需要一些工具来校验测试结论。</p>
<p>我们可以使用任何断言来验证结论。前面的例子中，我们使用Chai的<code>assert</code>函数来验证值的真实性。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">assert(callback.calledOnce);</span><br></pre></td></tr></table></figure>
<p>这样做的问题是错误信息并不清晰。你将得到“false was not true”，或类似信息。你可以想象的到，这对于定位错误并不是很有价值，你需要在测试代码中翻找才能最终找到。一点都不美。</p>
<p>解决这个问题，我们可恶意包含一个自定义的错误信息在断言中。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">assert(callback.calledOnce, <span class="string">'Callback was not called once'</span>);</span><br></pre></td></tr></table></figure>
<p>但如果我们使用sinon的断言库呢？</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">describe(<span class="string">'myFunction'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  it(<span class="string">'should call the callback function'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> callback = sinon.spy();</span><br><span class="line"></span><br><span class="line">    myFunction(<span class="literal">true</span>, callback);</span><br><span class="line"></span><br><span class="line">    sinon.assert.calledOnce(callback);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>使用sinon断言我们可以得到更多有价值的错误信息。这在当你验证比较复杂的条件时非常有用，例如函数的参数。</p>
<p>下面列出一些sinon提供的其它强大断言的一些例子：</p>
<ul>
<li><code>sinon.assert.calledWith</code>可以用来验证函数是否使用指定的参数（这可能是我用的最多的一个）</li>
<li><code>sinon.assert.callOrder</code>用来验证函数的调用顺序</li>
</ul>
<p><a href="http://sinonjs.org/docs/#assertions" target="_blank" rel="noopener">sinon断言文档</a>介绍了所有的内容。如果你喜欢使用Chai，有一个<a href="https://github.com/domenic/sinon-chai" target="_blank" rel="noopener">sinon-chai-plugin</a>可以让你通过chai的<code>expect</code>和<code>should</code>接口来使用sinon断言。</p>
<h3 id="Stubs"><a href="#Stubs" class="headerlink" title="Stubs"></a>Stubs</h3><p>stubs归类于test-doubles是因为它的灵活和方便性。它拥有spies的全部功能，此外它还彻底的替换掉了目标函数。换句话说，当你使用spy，原始的函数依然会被调用，但如果使用stub，原始函数就不会被执行了。</p>
<p>这个特性让stub可以胜任许多任务，例如：</p>
<ul>
<li>替换像ajax或其它外部函数等让测试变复杂或慢的调用</li>
<li>根据函数的响应来触发不同的代码流程</li>
<li>测试不寻常的条件，如抛出异常</li>
</ul>
<p>我们可以像创建spies一样创建stubs：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">var</span> stub = sinon.stub();</span><br><span class="line"></span><br><span class="line">stub(<span class="string">'hello'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(stub.firstCall.args); <span class="comment">//output: ['hello']</span></span><br></pre></td></tr></table></figure>
<p>我们创建了一个匿名的stubs，但用stubs来替换存在的函数更有意义。</p>
<p>举个例子，如果你有一段代码调用了jquery的Ajax，测试它将变得麻烦。代码会发送请求到我们配置的服务端，所以我们需要保证服务端的有效性，或者给代码添加特定的分支来适配测试环境 – 这么做真的大错特错。你不应该在代码中编写任何测试特定逻辑。</p>
<p>我们可以使用sinon的stub来替换ajax调用。这会让测试变得简单。</p>
<p>下面的例子中，我们使用ajax向预定url发送一个携带参数的请求。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">saveUser</span>(<span class="params">user, callback</span>) </span>&#123;</span><br><span class="line">  $.post(<span class="string">'/users'</span>, &#123;</span><br><span class="line">    first: user.firstname,</span><br><span class="line">    last: user.lastname</span><br><span class="line">  &#125;, callback);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通常，测试这个函数将变的很麻烦，但我们有了stub，一切变得美好。</p>
<p>假如我们想要确保传递给<code>saveUser</code>函数的回调方法在请求结束后正确的被执行了一次。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">describe(<span class="string">'saveUser'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  it(<span class="string">'should call callback after saving'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//We'll stub $.post so a request is not sent</span></span><br><span class="line">    <span class="keyword">var</span> post = sinon.stub($, <span class="string">'post'</span>);</span><br><span class="line">    post.yields();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//We can use a spy as the callback so it's easy to verify</span></span><br><span class="line">    <span class="keyword">var</span> callback = sinon.spy();</span><br><span class="line"></span><br><span class="line">    saveUser(&#123; <span class="attr">firstname</span>: <span class="string">'Han'</span>, <span class="attr">lastname</span>: <span class="string">'Solo'</span> &#125;, callback);</span><br><span class="line"></span><br><span class="line">    post.restore();</span><br><span class="line">    sinon.assert.calledOnce(callback);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>See the Pen <a href="http://codepen.io/SitePoint/pen/vGOrwj/" target="_blank" rel="noopener">Sinon Tutorial: JavaScript Testing with Mocks, Spies &amp; Stubs</a></p>
<p>这里，我们将ajax函数替换成了stub。这意味着请求不会被发送，我们不需要一个服务端 – 我们全权控制了我们的测试代码！</p>
<p>介于我们想确认我们传给<code>saveUser</code>的回调会被执行，我们让stub立刻返回。这意味着stub将自动调用callback参数。这模仿了<code>$.post</code>在请求完成后的行为。</p>
<p>除了stub，我们还创建了一个spy。我们可以使用一个普通的函数作为回调，但使用spy会让<code>sinon.assert.calledOnce</code>更方便验证测试结论。</p>
<p>大多数需要stub的场景，都类似下面步骤：</p>
<ul>
<li>确认是否包含问题函数，例如<code>$.post</code></li>
<li>观察并掌握其行为</li>
<li>创建一个stub</li>
<li>让stub来模拟目标行为</li>
</ul>
<p>stub不需要模拟所有的行为，只需要足够你的测试项使用即可，其它细节可以忽略。</p>
<p>另外一些stub的常用场景是验证一个函数是否使用特定的参数。</p>
<p>举个例子，在我们的ajax函数中，我们希望确定正确的数据被提交。因此，我们可能会这么做：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">describe(<span class="string">'saveUser'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  it(<span class="string">'should send correct parameters to the expected URL'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//We'll stub $.post same as before</span></span><br><span class="line">    <span class="keyword">var</span> post = sinon.stub($, <span class="string">'post'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//We'll set up some variables to contain the expected results</span></span><br><span class="line">    <span class="keyword">var</span> expectedUrl = <span class="string">'/users'</span>;</span><br><span class="line">    <span class="keyword">var</span> expectedParams = &#123;</span><br><span class="line">      first: <span class="string">'Expected first name'</span>,</span><br><span class="line">      last: <span class="string">'Expected last name'</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//We can also set up the user we'll save based on the expected data</span></span><br><span class="line">    <span class="keyword">var</span> user = &#123;</span><br><span class="line">      firstname: expectedParams.first,</span><br><span class="line">      lastname: expectedParams.last</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    saveUser(user, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;&#125; );</span><br><span class="line">    post.restore();</span><br><span class="line"></span><br><span class="line">    sinon.assert.calledWith(post, expectedUrl, expectedParams);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>see the pen <a href="http://codepen.io/SitePoint/pen/eZNKqZ/" target="_blank" rel="noopener">Sinon Tutorial: JavaScript Testing with Mocks, Spies &amp; Stubs</a></p>
<p>这次，我们有创建了一个<code>$.post()</code>的stub，但这回我们并没有让它直接返回。这次我们的测试目标不是回调，因此让它返回并不是必须的。</p>
<p>我们设置了一些变量来存期望的数据 - url和参数。这是一个好的实践，让我们很容易知道什么是测试必须的。也可以帮助我们减少重复代码。</p>
<p>这次我们使用<code>sinon.assert.calledWith()</code>断言。我们将stub传递进去，因为我们想确定stub包含了正确的参数。</p>
<p>使用sinon，还有其它的方法来测试ajax请求。例如使用sinon的伪造XMLHttpResquest功能。我们不会在这里去介绍细节，如果你想了解更多可以参考<a href="http://codeutopia.net/blog/2015/03/21/unit-testing-ajax-requests-with-mocha/" target="_blank" rel="noopener">my article on Ajax testing with Sinon’s fake XMLHttpRequest</a>。</p>
<h3 id="Mocks"><a href="#Mocks" class="headerlink" title="Mocks"></a>Mocks</h3><p>Mocks不同于stubs。如果你之前听过<code>mock object</code>这个术语，那没错了 - sinon的mocks用来替换整个对象，并改变其行为。</p>
<p>如果你需要替换某个对象的多个方法，你就应该使用mocks。如果你只是希望替换某个单独的方法，stub更方便。</p>
<p>使用mocks时你需要小心！因为它太TM强大了，很容易让你的测试过于特定 - 测试的太细或太刻意 - 从而让你的测试太容易过期。</p>
<p>与spies和stubs不同，mocks包含内建的断言。当使用mock对象时，你可以定义你期望的结果，你期望的行为。</p>
<p>假设我们使用<a href="https://github.com/marcuswestin/store.js" target="_blank" rel="noopener">store.js</a>来保存一些数据到localstorage，我们打算测试这个特性。我们可以使用mock来写测试：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">describe(<span class="string">'incrementStoredData'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  it(<span class="string">'should increment stored value by one'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> storeMock = sinon.mock(store);</span><br><span class="line">    storeMock.expects(<span class="string">'get'</span>).withArgs(<span class="string">'data'</span>).returns(<span class="number">0</span>);</span><br><span class="line">    storeMock.expects(<span class="string">'set'</span>).once().withArgs(<span class="string">'data'</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    incrementStoredData();</span><br><span class="line"></span><br><span class="line">    storeMock.restore();</span><br><span class="line">    storeMock.verify();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>See the Pen <a href="http://codepen.io/SitePoint/pen/EKjpYW/" target="_blank" rel="noopener">Sinon Tutorial: JavaScript Testing with Mocks, Spies &amp; Stubs</a>。</p>
<p>使用mocks时，我们可以使用链式调用风格来定义期望的调用和结果。这和使用断言验证结果一样，除了我们需要提前定义，并在测试结束时校验它们<code>storeMock.verify()</code>。</p>
<p>调用mock对象的<code>mock.expects(something)</code>会创建一个期望值。意味着<code>mock.something()</code>方法期望被调用。Each expectation, in addition to mock-specific functionality, supports the same functions as spies and stubs.（译者注：只能意会无法言表啊）</p>
<p>你可能会觉得通常stub都比mock更简单 - 没错。Mocks要小心使用。</p>
<p>mock特定的特性，可以查看<a href="http://sinonjs.org/docs/#mocks" target="_blank" rel="noopener">sinon的mock文档</a>。</p>
<h3 id="重要的最佳实践：使用sinon-test"><a href="#重要的最佳实践：使用sinon-test" class="headerlink" title="重要的最佳实践：使用sinon.test()"></a>重要的最佳实践：使用sinon.test()</h3><p>这里有个使用sion的很重要的最佳实践，不管是使用spies，stubs还是mocks都应该牢记。</p>
<p>如果你用test-doubles替换了一个存在的函数，则使用<code>sinon.test()</code>。</p>
<p>前面的例子中，我们使用<code>stub.restore()</code>或<code>mock.restore()</code>来在我们使用完后清理它们。这很有必要，否则test-doubles将持续有效，这将可能影响其他的测试项并导致错误。</p>
<p>但是，直接使用<code>restore()</code>可能很难，有可能因为某个异常导致<code>restore()</code>没有被调用！</p>
<p>我们有两种方法来解决这个问题：我们可以自己包装完整的<code>try catch</code>块。这允许我们将<code>restore()</code>放在<code>finally</code>块中调用来确保一切正常。</p>
<p>或者，一个更好的做法是我们可以将测试体写在<code>sinon.test()</code>中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">it(&apos;should do something with stubs&apos;, sinon.test(function() &#123;</span><br><span class="line">  var stub = this.stub($, &apos;post&apos;);</span><br><span class="line"></span><br><span class="line">  doSomething();</span><br><span class="line"></span><br><span class="line">  sinon.assert.calledOnce(stub);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>上面的代码中，注意<code>it()</code>的第二个参数，它被<code>sinon.test()</code>包裹。此外注意我们使用<code>this.stub()</code>代替了<code>sinon.stub()</code>。</p>
<p>使用<code>sinon.test()</code>包裹测试体可以让我们使用sinon沙盒特性，其允许我们使用<code>this.spy()</code>，<code>this.stub()</code>和<code>this.mock()</code>来创建spies， stubs和mocks。任何你在沙盒中创建的test-doubles都会自动被清理。</p>
<p>我们上面的代码中并没有<code>stub.restore()</code> – 托沙盒的福它已经不再需要了。</p>
<p>请尽可能使用<code>sinon.test()</code>，你会避免由于前面的测试项没有清理test-doubles而导致的灵异问题。</p>
<h3 id="Sinon并不是黑魔法"><a href="#Sinon并不是黑魔法" class="headerlink" title="Sinon并不是黑魔法"></a>Sinon并不是黑魔法</h3><p>Sinon很强大，而且某些时候很难理解它是如何工作的。让我们看一下Sion工作原理的原生javascript的例子，这样我们可以更好的理解其思想。</p>
<p>我们可以自己实现spies， stubs和mocks。使用Sinon只是因为它更方便 – 自己实现会非常复杂。</p>
<p>首先，spy本质上是一个函数wrapper：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//A simple spy helper</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createSpy</span>(<span class="params">targetFunc</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> spy = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    spy.args = <span class="built_in">arguments</span>;</span><br><span class="line">    spy.returnValue = targetFunc.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">    <span class="keyword">return</span> spy.returnValue;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> spy;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Let's spy on a simple function:</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sum</span>(<span class="params">a, b</span>) </span>&#123; <span class="keyword">return</span> a + b; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> spiedSum = createSpy(sum);</span><br><span class="line"></span><br><span class="line">spiedSum(<span class="number">10</span>, <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(spiedSum.args); <span class="comment">//Output: [10, 5]</span></span><br><span class="line"><span class="built_in">console</span>.log(spiedSum.returnValue); <span class="comment">//Output: 15</span></span><br></pre></td></tr></table></figure>
<p>我们可以很容易的使用自定义函数来实现spy的功能。但注意sinon的spies提供了非常多的特性 – 包括断言的支持。这让sinon更方便使用。</p>
<h4 id="关于Stub-Then？"><a href="#关于Stub-Then？" class="headerlink" title="关于Stub Then？"></a>关于Stub Then？</h4><p>实现一个简单的stub， 你可以简单的替换成一个新的：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">var</span> stub = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> original = thing.otherFunction;</span><br><span class="line">thing.otherFunction = stub;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Now any calls to thing.otherFunction will call our stub instead</span></span><br></pre></td></tr></table></figure>
<p>但是，sinon的stub提供了许多更好用的功能：</p>
<ul>
<li>它们拥有spy的全特性</li>
<li>你可以调用<code>stub.restore()</code>来恢复原始的行为</li>
<li>你可以结合sinon的断言</li>
</ul>
<p>Mocks simply combine the behavior of spies and stubs, making it possible to use their features in different ways.</p>
<p>尽管有时候sinon看起来像个“黑魔法”，但它的大多数功能其实很容易自己实现。但比起自己来实现一套来说，sinon非常方便使用。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>真实项目的测试有时非常的复杂，导致你可能彻底放弃。但是使用sinon，测试变得非常简单。</p>
<p>记住一个重要的准则：如果一个函数很难被测试，尝试使用test-doubles替换它。</p>
<p>想知道更多关于如何让你的代码使用sinon？当我的网站来，我会提供<a href="https://codeutopia.net/go/sinon-pdf-download-page/" target="_blank" rel="noopener">Sinon in the real-world guide</a>给你，包含了sinon的最佳实践，和三个真实的例子来讲解如何在不同的测试方案中使用它。</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:edisondik@gmail.com">kazaff</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://blog.kazaff.me/2016/11/11/译-Sinon入门：利用Mocks，Spies和Stubs完成javascript测试/">https://blog.kazaff.me/2016/11/11/译-Sinon入门：利用Mocks，Spies和Stubs完成javascript测试/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/test/">test</a><a class="post-meta__tags" href="/tags/ajax/">ajax</a><a class="post-meta__tags" href="/tags/mock/">mock</a><a class="post-meta__tags" href="/tags/sinon/">sinon</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/weichat.png"><div class="post-qr-code__desc">微信打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/alipay.png"><div class="post-qr-code__desc">支付宝打赏</div></div></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2016/11/14/javascript项目单元测试小结/"><i class="fa fa-chevron-left">  </i><span>Javascript项目单元测试小结</span></a></div><div class="next-post pull-right"><a href="/2016/11/07/一次被咨询后的感触/"><span>一次被咨询后的感触</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="disqus_thread"></div><script>var unused = null;
var disqus_config = function () {
  this.page.url = 'https://blog.kazaff.me/2016/11/11/译-Sinon入门：利用Mocks，Spies和Stubs完成javascript测试/';
  this.page.identifier = '2016/11/11/译-Sinon入门：利用Mocks，Spies和Stubs完成javascript测试/';
  this.page.title = '译-Sinon入门:利用Mocks，Spies和Stubs完成javascript测试';
}
var d = document, s = d.createElement('script');
s.src = "https://" + 'http-blog-kazaff-me' +".disqus.com/embed.js";
s.setAttribute('data-timestamp', '' + +new Date());
(d.head || d.body).appendChild(s);</script><script id="dsq-count-scr" src="https://http-blog-kazaff-me.disqus.com/count.js" async></script></div></div><footer class="footer-bg" style="background-image: url(/img/banner.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2014 - 2021 By kazaff</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>