title:  nodejs+pm2环境搭建
date: 2021-10-28 09:37:00
tags:
- pm2
- win7
- 开机

categories: 运维
---

今天真是个刺激的一天啊，事情是这样的：我打算部署一套新程序，需要分别在centos服务器和普通客户机上分别部署组件。本来以为这些都是小case，轻轻松松搞定，可没想到折腾了整整6个小时！

一开始是因为服务器上的nodejs版本太低，需要升级到足够新的版本才能运行我的目标程序。但是服务器上运行着很多已经部署过的程序，这些程序已经运行了三年多了，我实在不愿意去碰它们，但是手头上确实没有其他更合适的机器用了，硬着头皮上吧~~

幸好之前搭建服务器的时候就安装过nodejs的版本管理工具`nvm`，这玩意儿可以让我快速在不同的版本之间切换，所以到目前为止还算顺利。我要做的只是切换到目标版本，然后保证所有的程序都可以正常运行即可~~虽然中间耽误了一些时间来排查老程序的版本兼容问题，但一切都难不倒我~~

服务器部署完毕后，我远程连接到一台客户机上，噩梦开始了！！！不出意外的发现nodejs版本也要升级，而且我依然利用`nvm`安装了最新的LTS版本，然后懵逼了，因为切换不过去。。。一头雾水的我又换了一个nodejs的版本管理工具`nodist`，依然扑街。。

一直持续到我发现，原来`win7`系统支持的最新的nodejs版本是`v13.14.0`，fuck！而且不确定什么原因，我的`nvm`和`nodist`都无法快速安装这个版本，我只能全部卸载它们，然后手动安装这个nodejs版本。

安装很顺利，要跑的程序也都正常运行了。接下来要使用`pm2`来管理我的nodejs进程，并配置开机自动重启设置。我随手就潇洒的装上[pm2-windows-service](https://www.npmjs.com/package/pm2-windows-service)这个库，就像我在其他机器上做的一样，简直酷毙了~

当我快速的执行`pm2-service-install`命令时，本以为下一秒我就能结束战斗了，没想到新一轮的噩梦到来了。这个命令总是卡死控制台，[解决卡死问题后](https://github.com/jon-hall/pm2-windows-service/issues/51#issuecomment-444160883)，又发现它导致我安装好的`pm2`无法保存配置了，更别提重启后自动运行了！!

我按照社区里的信息，反复卸载，反复升级依赖的库，不同的重启机器测试，毫无意义！直到最后我开始怀疑依然是因为操作系统版本导致的这个杯具，我放弃了`pm2-windows-service`这个库，换了一个更小众更古老的库：[pm2-windows-startup](https://www.npmjs.com/package/pm2-windows-startup)，一切问题都消失不见了，世界又恢复了往日的美好~~


今天的经历告诉我：珍惜生命，远离部署！！！